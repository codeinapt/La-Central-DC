<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Admin</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>🔐 Panel de Administración</h1>

  <div id="login">
    <h2>Acceso restringido</h2>
    <input type="password" id="clave" placeholder="Ingrese contraseña" />
    <button onclick="verificarClave()">Entrar</button>
  </div>

  <div id="contenido" style="display:none;">
    <div class="container">
      <div class="controls">
        <button onclick="mostrarSeccion('usuarios')">👤 Usuarios</button>
        <button onclick="mostrarSeccion('deudas')">💰 Deudas</button>
      </div>

      <!-- Sección Usuarios -->
      <div id="seccionUsuarios">
        <h2>Usuarios</h2>
        <div class="controls">
          <input id="nombreUsuario" placeholder="Nombre del usuario" />
          <button id="btnAgregarUsuario">Agregar Usuario</button>
        </div>
        <table id="tablaUsuarios">
          <tr><th>Nombre</th><th>Deudas</th><th>Acción</th></tr>
        </table>
      </div>

      <!-- Sección Deudas -->
      <div id="seccionDeudas" style="display:none;">
        <h2>Deudas</h2>
        <div class="controls">
          <input id="descripcion" placeholder="Descripción" />
          <input id="monto" type="number" placeholder="Monto" />
          <input id="fecha" type="date" />
          <button id="btnAgregarDeuda">Agregar Deuda</button>
        </div>
        <table id="tablaDeudas">
          <tr><th>Descripción</th><th>Monto</th><th>Fecha</th><th>Acción</th></tr>
        </table>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
  // Configuración Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAX52Luy0Ehmy2Gzcj9E_oV4NgLTngIrsw",
    authDomain: "finanzas-9cf9a.firebaseapp.com",
    databaseURL: "https://finanzas-9cf9a-default-rtdb.firebaseio.com",
    projectId: "finanzas-9cf9a",
    storageBucket: "finanzas-9cf9a.firebasestorage.app",
    messagingSenderId: "619666520117",
    appId: "1:619666520117:web:769672477e884d8bed597c",
    measurementId: "G-SJX7L1VH78"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database(app);
  const refUsuarios = db.ref("usuarios");
  const refDeudas = db.ref("deudas");

  const CLAVE_ADMIN = "12345";

  function verificarClave() {
    const clave = document.getElementById("clave").value;
    if (clave === CLAVE_ADMIN) {
      document.getElementById("login").style.display = "none";
      document.getElementById("contenido").style.display = "block";
      cargarUsuarios();
      cargarDeudas();
    } else alert("Clave incorrecta");
  }

  function mostrarSeccion(seccion) {
    document.getElementById("seccionUsuarios").style.display = seccion === "usuarios" ? "block" : "none";
    document.getElementById("seccionDeudas").style.display = seccion === "deudas" ? "block" : "none";
  }

  // 🧍 Agregar usuario
  document.getElementById("btnAgregarUsuario").addEventListener("click", async () => {
    const nombre = document.getElementById("nombreUsuario").value.trim();
    if (!nombre) return alert("Ingrese un nombre");
    const nuevoRef = refUsuarios.push();
    const snapshotDeudas = await refDeudas.get();
    const deudasExistentes = snapshotDeudas.val() || {};
    const deudasUsuario = {};
    for (const id in deudasExistentes) {
      deudasUsuario[id] = { ...deudasExistentes[id], pagado: false };
    }
    await nuevoRef.set({ nombre, deudas: deudasUsuario });
    document.getElementById("nombreUsuario").value = "";
  });

  // 💰 Agregar deuda
  document.getElementById("btnAgregarDeuda").addEventListener("click", async () => {
    const descripcion = document.getElementById("descripcion").value.trim();
    const monto = document.getElementById("monto").value.trim();
    const fecha = document.getElementById("fecha").value;
    if (!descripcion || !monto || !fecha) return alert("Complete todos los campos");

    const nuevaRef = refDeudas.push();
    const nuevaDeuda = { descripcion, monto, fecha };
    await nuevaRef.set(nuevaDeuda);

    // Asignar a todos los usuarios
    const snapshotUsuarios = await refUsuarios.get();
    snapshotUsuarios.forEach(u => {
      db.ref(`usuarios/${u.key}/deudas/${nuevaRef.key}`).set({ ...nuevaDeuda, pagado: false });
    });

    document.getElementById("descripcion").value = "";
    document.getElementById("monto").value = "";
    document.getElementById("fecha").value = "";
  });

  // 👥 Cargar usuarios
  function cargarUsuarios() {
    refUsuarios.on("value", (snap) => {
      const data = snap.val() || {};
      const tabla = document.getElementById("tablaUsuarios");
      tabla.innerHTML = "<tr><th>Nombre</th><th>Deudas</th><th>Acción</th></tr>";
      for (let id in data) {
        const usuario = data[id];
        let deudasHtml = "";
        if (usuario.deudas) {
          // Ordenar deudas por fecha descendente
          const deudasOrdenadas = Object.entries(usuario.deudas).sort((a, b) => new Date(b[1].fecha) - new Date(a[1].fecha));
          for (let [idDeuda, deuda] of deudasOrdenadas) {
            const estilo = deuda.pagado ? 'style="background:#0044cc;"' : "";
            const fechaFmt = formatearFecha(deuda.fecha);
            deudasHtml += `<div ${estilo} onclick="togglePagado('${id}','${idDeuda}')">
              ${deuda.descripcion}: $${deuda.monto} <span class='small'>(${fechaFmt})</span>
            </div>`;
          }
        }
        tabla.innerHTML += `
          <tr>
            <td>${usuario.nombre}</td>
            <td>${deudasHtml}</td>
            <td><button class="btn-danger" onclick="eliminarUsuario('${id}')">🗑</button></td>
          </tr>`;
      }
    });
  }

  // 📋 Cargar deudas
  function cargarDeudas() {
    refDeudas.on("value", (snap) => {
      const data = snap.val() || {};
      const tabla = document.getElementById("tablaDeudas");
      tabla.innerHTML = "<tr><th>Descripción</th><th>Monto</th><th>Fecha</th><th>Acción</th></tr>";

      // Ordenar por fecha (más reciente primero)
      const deudasOrdenadas = Object.entries(data).sort((a, b) => new Date(b[1].fecha) - new Date(a[1].fecha));
      for (let [id, deuda] of deudasOrdenadas) {
        const fechaFmt = formatearFecha(deuda.fecha);
        tabla.innerHTML += `
          <tr>
            <td>${deuda.descripcion}</td>
            <td>${deuda.monto}</td>
            <td>${fechaFmt}</td>
            <td><button class="btn-danger" onclick="eliminarDeuda('${id}')">🗑</button></td>
          </tr>`;
      }
    });
  }

  // 📅 Formatear fecha legible
  function formatearFecha(fechaIso) {
    try {
      const fecha = new Date(fechaIso);
      return fecha.toLocaleDateString("es-CO", {
        day: "numeric",
        month: "short",
        year: "numeric"
      });
    } catch {
      return fechaIso;
    }
  }

  // 🔄 Cambiar estado de pago
  function togglePagado(idUsuario, idDeuda) {
    const refDeuda = db.ref(`usuarios/${idUsuario}/deudas/${idDeuda}`);
    refDeuda.once("value").then((snap) => {
      const actual = snap.val();
      refDeuda.update({ pagado: !actual.pagado });
    });
  }

  // ❌ Eliminar usuario
  function eliminarUsuario(idUsuario) {
    if (confirm("¿Seguro que deseas eliminar este usuario?")) {
      db.ref(`usuarios/${idUsuario}`).remove();
    }
  }

  // ❌ Eliminar deuda
  async function eliminarDeuda(idDeuda) {
    if (!confirm("¿Seguro que deseas eliminar esta deuda?")) return;
    await db.ref(`deudas/${idDeuda}`).remove();
    const snapshotUsuarios = await refUsuarios.get();
    snapshotUsuarios.forEach(u => {
      db.ref(`usuarios/${u.key}/deudas/${idDeuda}`).remove();
    });
  }
</script>

</body>
</html>
