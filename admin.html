<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Admin</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>🔐 Panel de Administración</h1>

  <div id="login">
    <h2>Acceso restringido</h2>
    <input type="password" id="clave" placeholder="Ingrese contraseña" />
    <button onclick="verificarClave()">Entrar</button>
  </div>

  <div id="contenido" style="display:none;">
    <div class="container">
      <div class="controls">
        <button onclick="mostrarSeccion('usuarios')">👤 Usuarios</button>
        <button onclick="mostrarSeccion('deudas')">💰 Deudas</button>
      </div>

      <!-- Sección Usuarios -->
      <div id="seccionUsuarios">
        <h2>Usuarios</h2>
        <div class="controls">
          <input id="nombreUsuario" placeholder="Nombre del usuario" />
          <button id="btnAgregarUsuario">Agregar Usuario</button>
        </div>
        <table id="tablaUsuarios">
          <tr><th>Nombre</th><th>Deudas</th></tr>
        </table>
      </div>

      <!-- Sección Deudas -->
      <div id="seccionDeudas" style="display:none;">
        <h2>Deudas</h2>
        <div class="controls">
          <input id="descripcion" placeholder="Descripción" />
          <input id="monto" type="number" placeholder="Monto" />
          <button id="btnAgregarDeuda">Agregar Deuda</button>
        </div>
        <table id="tablaDeudas">
          <tr><th>Descripción</th><th>Monto</th></tr>
        </table>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAX52Luy0Ehmy2Gzcj9E_oV4NgLTngIrsw",
      authDomain: "finanzas-9cf9a.firebaseapp.com",
      databaseURL: "https://finanzas-9cf9a-default-rtdb.firebaseio.com",
      projectId: "finanzas-9cf9a",
      storageBucket: "finanzas-9cf9a.firebasestorage.app",
      messagingSenderId: "619666520117",
      appId: "1:619666520117:web:769672477e884d8bed597c",
      measurementId: "G-SJX7L1VH78"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database(app);
    const refUsuarios = db.ref("usuarios");
    const refDeudas = db.ref("deudas");

    const CLAVE_ADMIN = "12345";

    function verificarClave() {
      const clave = document.getElementById("clave").value;
      if (clave === CLAVE_ADMIN) {
        document.getElementById("login").style.display = "none";
        document.getElementById("contenido").style.display = "block";
        cargarUsuarios();
        cargarDeudas();
      } else alert("Clave incorrecta");
    }

    function mostrarSeccion(seccion) {
      document.getElementById("seccionUsuarios").style.display = seccion === "usuarios" ? "block" : "none";
      document.getElementById("seccionDeudas").style.display = seccion === "deudas" ? "block" : "none";
    }

    // ➕ Agregar usuario
    document.getElementById("btnAgregarUsuario").addEventListener("click", async () => {
      const nombre = document.getElementById("nombreUsuario").value.trim();
      if (!nombre) return alert("Ingrese un nombre");
      const nuevoRef = refUsuarios.push();
      const snapshotDeudas = await refDeudas.get();
      const deudasExistentes = snapshotDeudas.val() || {};
      const deudasUsuario = {};
      for (const id in deudasExistentes) {
        deudasUsuario[id] = { ...deudasExistentes[id], pagado: false };
      }
      await nuevoRef.set({ nombre, deudas: deudasUsuario });
      document.getElementById("nombreUsuario").value = "";
    });

    // ➕ Agregar deuda
    document.getElementById("btnAgregarDeuda").addEventListener("click", async () => {
      const descripcion = document.getElementById("descripcion").value.trim();
      const monto = document.getElementById("monto").value.trim();
      if (!descripcion || !monto) return alert("Complete los campos");
      const nuevaRef = refDeudas.push();
      await nuevaRef.set({ descripcion, monto });

      // Asignar esta deuda a todos los usuarios
      const snapshotUsuarios = await refUsuarios.get();
      snapshotUsuarios.forEach(u => {
        db.ref(`usuarios/${u.key}/deudas/${nuevaRef.key}`).set({ descripcion, monto, pagado: false });
      });

      document.getElementById("descripcion").value = "";
      document.getElementById("monto").value = "";
    });

    // 👥 Cargar usuarios
    function cargarUsuarios() {
      refUsuarios.on("value", (snap) => {
        const data = snap.val() || {};
        const tabla = document.getElementById("tablaUsuarios");
        tabla.innerHTML = "<tr><th>Nombre</th><th>Deudas</th></tr>";
        for (let id in data) {
          const usuario = data[id];
          let deudasHtml = "";
          if (usuario.deudas) {
            for (let idDeuda in usuario.deudas) {
              const deuda = usuario.deudas[idDeuda];
              const estilo = deuda.pagado ? 'style="background:#0044cc;"' : "";
              deudasHtml += `<div ${estilo} onclick="togglePagado('${id}','${idDeuda}')">
                ${deuda.descripcion}: $${deuda.monto}
              </div>`;
            }
          }
          tabla.innerHTML += `<tr><td>${usuario.nombre}</td><td>${deudasHtml}</td></tr>`;
        }
      });
    }

    // 💰 Cargar deudas
    function cargarDeudas() {
      refDeudas.on("value", (snap) => {
        const data = snap.val() || {};
        const tabla = document.getElementById("tablaDeudas");
        tabla.innerHTML = "<tr><th>Descripción</th><th>Monto</th></tr>";
        for (let id in data) {
          tabla.innerHTML += `<tr><td>${data[id].descripcion}</td><td>${data[id].monto}</td></tr>`;
        }
      });
    }

    // 🔄 Cambiar estado de pago
    function togglePagado(idUsuario, idDeuda) {
      const refDeuda = db.ref(`usuarios/${idUsuario}/deudas/${idDeuda}`);
      refDeuda.once("value").then((snap) => {
        const actual = snap.val();
        refDeuda.update({ pagado: !actual.pagado });
      });
    }
  </script>
</body>
</html>
