<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deudas â€” PÃºblica</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>Tabla de deudas (vista pÃºblica)</h1>
    <p class="small">Solo lectura â€” cualquier cambio lo hace el admin.</p>
    <div id="tablaContainer"></div>
  </div>

  <!-- Firebase SDKs: app + database -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js"></script>


  <script>
    // ðŸ”§ ConfiguraciÃ³n de tu proyecto (personalÃ­zala con tu propia config de Firebase)
    const firebaseConfig = {
      apiKey: "AIzaSyAX52Luy0Ehmy2Gzcj9E_oV4NgLTngIrsw",
      authDomain: "finanzas-9cf9a.firebaseapp.com",
      databaseURL: "https://finanzas-9cf9a-default-rtdb.firebaseio.com",
      projectId: "finanzas-9cf9a",
      storageBucket: "finanzas-9cf9a.firebasestorage.app",
      messagingSenderId: "619666520117",
      appId: "1:619666520117:web:769672477e884d8bed597c",
      measurementId: "G-SJX7L1VH78"
    };
 // =============================================
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const fieldsRef = db.ref("fields");
    const usersRef = db.ref("usuarios");

    function formatNumber(n){ return Number(n||0).toFixed(2); }

    function renderTable(fieldsObj, usersObj){
      const container = document.getElementById("tablaContainer");
      const fields = fieldsObj ? Object.entries(fieldsObj) : [];
      const users = usersObj ? Object.entries(usersObj) : [];

      if (fields.length === 0) {
        container.innerHTML = "<p>No hay campos (conceptos) todavÃ­a.</p>";
        return;
      }

      let html = '<table><thead><tr><th>Nombre</th>';
      fields.forEach(([fKey, fName]) => html += `<th>${escapeHtml(fName)}</th>`);
      html += '<th>Total</th></tr></thead><tbody>';

      users.forEach(([uKey, uObj]) => {
        const nombre = uObj.nombre || '';
        const debts = uObj.debts || {};
        let total = 0;
        html += `<tr><td>${escapeHtml(nombre)}</td>`;
        fields.forEach(([fKey, fName]) => {
          const v = Number(debts[fKey] || 0);
          total += v;
          html += `<td>${formatNumber(v)}</td>`;
        });
        html += `<td>${formatNumber(total)}</td></tr>`;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // Escucha cambios en tiempo real
    fieldsRef.on("value", snapF => {
      usersRef.once("value", snapU => {
        renderTable(snapF.val(), snapU.val());
      });
    });

    // Si no hay fields aÃºn, intenta al menos con usuarios (por si se crean despuÃ©s)
    usersRef.on("value", snapU => {
      fieldsRef.once("value", snapF => {
        renderTable(snapF.val(), snapU.val());
      });
    });
  </script>
</body>
</html>
